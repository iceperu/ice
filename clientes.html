<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Clientes Ice : 7-8-9-10-11</title>
  <style>
    table {
      width: 90%;
      margin: 50px auto;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #a8e6a6;
    }
    .estado-btn {
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    .visitado {
      background-color: green;
    }
    .no-visitado {
      background-color: red;
    }
    .edit-cell {
      position: relative;
    }
    .edit-icon {
      cursor: pointer;
      margin-left: 5px;
      color: blue;
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
    }
    .edit-input {
      width: 90%;
      font-size: 14px;
      padding: 4px;
    }
    .password-modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 20px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      border-radius: 10px;
    }
    .password-modal input {
      padding: 10px;
      margin-bottom: 10px;
      font-size: 16px;
    }
    .password-modal button {
      padding: 8px 16px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <h2 style="text-align:center;">Clientes Ice : 7-8-9-10-11</h2>

  <div style="text-align: center; margin-top: 30px;">
    <input
      type="text"
      id="buscador"
      placeholder="Buscar por nombre, código o ruta..."
      style="width: 20%; padding: 10px; font-size: 16px;"
    />

    <!-- Filtros adicionales -->
    <select id="filtroRuta" style="padding: 10px; font-size: 16px;">
      <option value="">Filtrar por ruta</option>
      <option value="07">Ruta 07</option>
      <option value="08">Ruta 08</option>
      <option value="09">Ruta 09</option>
      <option value="10">Ruta 10</option>
      <option value="11">Ruta 11</option>
    </select>

    <select id="filtroEstado" style="padding: 10px; font-size: 16px;">
      <option value="">Filtrar por estado</option>
      <option value="visitado">Visitado</option>
      <option value="no-visitado">No visitado</option>
    </select>
  </div>

  <table>
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Código</th>
        <th>Ruta</th>
        <th>Ubicación</th>
        <th>Requerimientos</th>
        <th>Imagen</th>
        <th>Estado</th>
      </tr>
    </thead>
    <tbody id="clientes-body"></tbody>
  </table>

  <div id="password-modal" class="password-modal">
    <h3>Introduce la contraseña</h3>
    <input type="password" id="password-input" placeholder="Contraseña" />
    <button id="submit-password">Aceptar</button>
    <button id="cancel-password">Cancelar</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBMUS3oqZOtUsuxFsVRjwXRA7HKA2pdnKY",
      authDomain: "iceperu-5613a.firebaseapp.com",
      databaseURL: "https://iceperu-5613a-default-rtdb.firebaseio.com",
      projectId: "iceperu-5613a",
      storageBucket: "iceperu-5613a.appspot.com",
      messagingSenderId: "160752506128",
      appId: "1:160752506128:web:a2781301bd763db4388195",
      measurementId: "G-WD516HZ80N"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const todosLosClientes = [
       {
    nombre: "jaime coelle marina",
    codigo: "8050726",
    ruta: "08",
    ubicacion: "https://maps.app.goo.gl/cdQCsNwnzs5a97gN7",
    requerimientos: "",
    imagen: "https://i.postimg.cc/2jcTBHQ2/Whats-App-Image-2025-05-04-at-5-28-59-PM-4.jpg"
  },
  {
    nombre: "ore quispe mirian",
    codigo: "616326",
    ruta: "08",
    ubicacion: "https://maps.app.goo.gl/63X4gJ6jA2mJadGLA",
    requerimientos: ""
  },
  {
    nombre: "godoy bonilla emilia",
    codigo: "513511",
    ruta: "08",
    ubicacion: "falta",
    requerimientos: ""
  },
  {
    nombre: "valdivia vargas aurea",
    codigo: "8050729",
    ruta: "08",
    ubicacion: "https://maps.app.goo.gl/rxbiqn5ZFPNDZ43Q6",
    requerimientos: ""
  },
  {
    nombre: "villalobos minaya isabel",
    codigo: "8050739",
    ruta: "08",
    ubicacion: "https://maps.app.goo.gl/PxPXWkpU5QF9w55v5",
    requerimientos: ""
  },
  {
    nombre: "bautista yamocca violeta",
    codigo: "8049946",
    ruta: "08",
    ubicacion: "https://maps.app.goo.gl/3ZU2Fpg7LRYDYGPT8",
    requerimientos: ""
  },
  {
    nombre: "machahuay vda de c",
    codigo: "628117",
    ruta: "08",
    ubicacion: "https://maps.app.goo.gl/dbDMxJDbhivn31Q77",
    requerimientos: ""
  },
  {
    nombre: "ccaico tomaylla sindy",
    codigo: "1379941",
    ruta: "08",
    ubicacion: "https://maps.app.goo.gl/wYdT1vojFV4p8y8C9",
    requerimientos: ""
  },
  {
    nombre: "berna quispe antonia",
    codigo: "603877",
    ruta: "08",
    ubicacion: "https://maps.app.goo.gl/31Trg2FX3wNP2rtP8",
    requerimientos: ""
  },
  {
    nombre: "flores huaranccay karol",
    codigo: "1144521",
    ruta: "08",
    ubicacion: "https://maps.app.goo.gl/qN62PxxF7pic5hRr6",
    requerimientos: ""
  },
  {
    nombre: "bajalqui espinoza marisol",
    codigo: "1142982",
    ruta: "08",
    ubicacion: "falta",
    requerimientos: ""
  },
  {
    nombre: "balboa alva marilu",
    codigo: "1019669",
    ruta: "08",
    ubicacion: "falta",
    requerimientos: "",
    imagen: "falta"
  },
  {
    nombre: "palomino espino yesenia",
    codigo: "674239",
    ruta: "08",
    ubicacion: "fata",
    requerimientos: "",
    imagen: "falta"
  },
  {
    nombre: "enciso martinez yvette",
    codigo: "742989",
    ruta: "08",
    ubicacion: "falta",
    requerimientos: "",
    imagen: "falta"
  },
  {
    nombre: "fuentes serrano rosa",
    codigo: "713485",
    ruta: "08",
    ubicacion: "falta",
    requerimientos: "",
    imagen: "falta"
  },
  {
    nombre: "mamani ccarhuancho gloria",
    codigo: "636814",
    ruta: "08",
    ubicacion: "falta",
    requerimientos: "",
    imagen: "falta"
  },
  {
    nombre: "quino challa juan",
    codigo: "1140789",
    ruta: "08",
    ubicacion: "falta",
    requerimientos: "",
    imagen: "falta"
  }
    ];

    // Función para obtener el estado (visitado/no-visitado) desde Firebase
    async function obtenerEstados() {
      const snapshot = await db.ref('clientes-ice').once('value');
      return snapshot.val() || {};
    }

    // Mostrar clientes en la tabla
    async function mostrarClientes() {
      const estados = await obtenerEstados();
      const tbody = document.getElementById('clientes-body');
      tbody.innerHTML = '';

      const filtroRuta = document.getElementById('filtroRuta').value.toLowerCase();
      const filtroEstado = document.getElementById('filtroEstado').value.toLowerCase();
      const textoBusqueda = document.getElementById('buscador').value.toLowerCase();

      todosLosClientes.forEach((cliente, index) => {
        const estado = estados[cliente.codigo] || 'no-visitado';

        // Aplicar filtros
        if (
          (filtroRuta && cliente.ruta.toLowerCase() !== filtroRuta) ||
          (filtroEstado && estado !== filtroEstado) ||
          (textoBusqueda &&
            !(
              cliente.nombre.toLowerCase().includes(textoBusqueda) ||
              cliente.codigo.toLowerCase().includes(textoBusqueda) ||
              cliente.ruta.toLowerCase().includes(textoBusqueda)
            ))
        ) {
          return;
        }

        const tr = document.createElement('tr');

        // Nombre con campo editable
        const tdNombre = document.createElement('td');
        tdNombre.classList.add('edit-cell');
        tdNombre.textContent = cliente.nombre;
        const editIcon = document.createElement('span');
        editIcon.textContent = '✎';
        editIcon.classList.add('edit-icon');
        tdNombre.appendChild(editIcon);
        tr.appendChild(tdNombre);

        // Código
        const tdCodigo = document.createElement('td');
        tdCodigo.textContent = cliente.codigo;
        tr.appendChild(tdCodigo);

        // Ruta
        const tdRuta = document.createElement('td');
        tdRuta.textContent = cliente.ruta;
        tr.appendChild(tdRuta);

        // Ubicación (link o texto)
        const tdUbicacion = document.createElement('td');
        if (cliente.ubicacion && cliente.ubicacion.toLowerCase() !== 'falta') {
          const link = document.createElement('a');
          link.href = cliente.ubicacion;
          link.textContent = 'Ver mapa';
          link.target = '_blank';
          tdUbicacion.appendChild(link);
        } else {
          tdUbicacion.textContent = 'No disponible';
        }
        tr.appendChild(tdUbicacion);

        // Requerimientos
        const tdReq = document.createElement('td');
        tdReq.textContent = cliente.requerimientos || '';
        tr.appendChild(tdReq);

        // Imagen (mostrar solo si hay URL válida)
        const tdImagen = document.createElement('td');
        if (cliente.imagen && cliente.imagen.toLowerCase() !== 'falta') {
          const img = document.createElement('img');
          img.src = cliente.imagen;
          img.alt = 'Imagen cliente';
          img.style.width = '50px';
          img.style.height = '50px';
          tdImagen.appendChild(img);
        } else {
          tdImagen.textContent = 'No disponible';
        }
        tr.appendChild(tdImagen);

        // Estado con botón para cambiar
        const tdEstado = document.createElement('td');
        const btnEstado = document.createElement('button');
        btnEstado.textContent = estado === 'visitado' ? 'Visitado' : 'No visitado';
        btnEstado.classList.add('estado-btn', estado === 'visitado' ? 'visitado' : 'no-visitado');

        btnEstado.addEventListener('click', () => {
          mostrarModalPassword(cliente.codigo, btnEstado);
        });

        tdEstado.appendChild(btnEstado);
        tr.appendChild(tdEstado);

        tbody.appendChild(tr);

        // Editar nombre al hacer click en el icono
        editIcon.addEventListener('click', () => {
          editarNombre(tdNombre, cliente);
        });
      });
    }

    function editarNombre(td, cliente) {
      const input = document.createElement('input');
      input.type = 'text';
      input.value = cliente.nombre;
      input.classList.add('edit-input');

      // Remover texto y el icono para editar
      td.textContent = '';
      td.appendChild(input);
      input.focus();

      input.addEventListener('blur', () => {
        const nuevoNombre = input.value.trim();
        if (nuevoNombre) {
          cliente.nombre = nuevoNombre;
          // No hay actualización en Firebase para nombre, solo UI
        }
        td.textContent = cliente.nombre;
        const editIcon = document.createElement('span');
        editIcon.textContent = '✎';
        editIcon.classList.add('edit-icon');
        td.appendChild(editIcon);
        editIcon.addEventListener('click', () => {
          editarNombre(td, cliente);
        });
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          input.blur();
        }
      });
    }

    // Modal para pedir contraseña
    const modal = document.getElementById('password-modal');
    const passwordInput = document.getElementById('password-input');
    const submitPasswordBtn = document.getElementById('submit-password');
    const cancelPasswordBtn = document.getElementById('cancel-password');

    let codigoActual = null;
    let botonActual = null;

    function mostrarModalPassword(codigo, boton) {
      codigoActual = codigo;
      botonActual = boton;
      passwordInput.value = '';
      modal.style.display = 'block';
      passwordInput.focus();
    }

    function ocultarModalPassword() {
      modal.style.display = 'none';
      codigoActual = null;
      botonActual = null;
    }

    submitPasswordBtn.addEventListener('click', () => {
      const pass = passwordInput.value;
      if (pass === '123456') {  // contraseña fija
        cambiarEstado(codigoActual, botonActual);
        ocultarModalPassword();
      } else {
        alert('Contraseña incorrecta');
      }
    });

    cancelPasswordBtn.addEventListener('click', () => {
      ocultarModalPassword();
    });

    // Cambiar estado en Firebase y actualizar UI
    function cambiarEstado(codigo, boton) {
      db.ref('clientes-ice/' + codigo).get().then((snapshot) => {
        const estadoActual = snapshot.exists() ? snapshot.val() : 'no-visitado';
        const nuevoEstado = estadoActual === 'visitado' ? 'no-visitado' : 'visitado';

        db.ref('clientes-ice/' + codigo).set(nuevoEstado).then(() => {
          boton.textContent = nuevoEstado === 'visitado' ? 'Visitado' : 'No visitado';
          boton.classList.toggle('visitado');
          boton.classList.toggle('no-visitado');
        });
      });
    }

    // Actualizar la tabla cada vez que se cambia el filtro o la búsqueda
    document.getElementById('buscador').addEventListener('input', mostrarClientes);
    document.getElementById('filtroRuta').addEventListener('change', mostrarClientes);
    document.getElementById('filtroEstado').addEventListener('change', mostrarClientes);

    // Carga inicial
    mostrarClientes();
  </script>
</body>
</html>

